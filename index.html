<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WatchMatch üé¨</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --primary:#8b5cf6; --secondary:#ec4899; --bg:#030712;
  --glass:rgba(255,255,255,.05); --glass-border:rgba(255,255,255,.1);
}
*{box-sizing:border-box;font-family:Poppins}
body{
  margin:0;height:100vh;display:flex;justify-content:center;align-items:center;
  background:radial-gradient(circle at top right,#1e1b4b,#030712);
  color:white;
}
.screen{display:none;width:90%;max-width:400px;height:90vh;flex-direction:column}
.screen.active{display:flex}
.glass-card{background:var(--glass);border:1px solid var(--glass-border);
border-radius:28px;padding:25px;backdrop-filter:blur(20px)}
.poster-container{flex:1;border-radius:25px;overflow:hidden;position:relative}
.poster-img{width:100%;height:100%;object-fit:cover}
.movie-info{position:absolute;bottom:0;width:100%;padding:40px 20px;
background:linear-gradient(transparent,rgba(0,0,0,.9))}
.btn-round{width:70px;height:70px;border-radius:50%;border:none;
font-size:28px;color:white;cursor:pointer}
.btn-main{border:none;padding:15px;border-radius:15px;
background:linear-gradient(135deg,var(--primary),var(--secondary));color:white}
.menu-toggle{background:none;border:none;color:white;font-size:26px}
input{width:100%;padding:12px;margin-bottom:10px;border-radius:12px;
background:rgba(255,255,255,.05);border:1px solid var(--glass-border);color:white}
</style>
</head>

<body>

<div id="screen-auth" class="screen active">
  <div class="glass-card">
    <h2>WatchMatch</h2>
    <input id="email" placeholder="E-mail">
    <input id="password" type="password" placeholder="Senha">
    <button class="btn-main" onclick="handleAuth('in')">Entrar</button>
    <button onclick="handleAuth('up')" style="background:none;color:#aaa;margin-top:10px">Criar conta</button>
  </div>
</div>

<div id="screen-main" class="screen">
  <button class="menu-toggle" onclick="logout()">‚éã</button>

  <div class="poster-container">
    <img id="poster" class="poster-img">
    <div class="movie-info">
      <h2 id="titulo">Carregando...</h2>
    </div>
  </div>

  <div style="display:flex;justify-content:space-evenly;margin:20px 0">
    <button class="btn-round" style="background:#1f2937" onclick="loadMovie()">‚úï</button>
    <button class="btn-round" style="background:linear-gradient(135deg,#ec4899,#8b5cf6)" onclick="handleLike()">‚ù§Ô∏è</button>
  </div>
</div>

<div id="match-popup" style="display:none;position:fixed;inset:0;
background:rgba(0,0,0,.95);z-index:10;align-items:center;justify-content:center;flex-direction:column">
  <h1>MATCH üéâ</h1>
  <img id="match-img" style="width:220px;border-radius:20px">
  <button class="btn-main" onclick="closeMatch()">Continuar</button>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://uttkzsonbyniifegawdh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0dGt6c29uYnluaWlmZWdhd2RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5Nzg0MTYsImV4cCI6MjA4NjU1NDQxNn0.uB8N7QWxVn6nIufmqjh2B2z8KFpR6MwKMjvuKRFRP60"
);

const TMDB = "https://api.themoviedb.org/3/trending/all/week?api_key=3d0612477f605d85e21708f54f1d58be&language=pt-BR";
let currentUser = null;
let currentMovie = null;

async function handleAuth(type){
  const email=email.value,password=password.value;
  const fn = type==='up'
    ? supabase.auth.signUp
    : supabase.auth.signInWithPassword;
  const {error}=await fn({email,password});
  if(error) return alert(error.message);
  checkUser();
}

async function checkUser(){
  const {data:{user}}=await supabase.auth.getUser();
  if(!user) return;
  currentUser=user;
  screen-auth.classList.remove("active");
  screen-main.classList.add("active");
  loadMovie();
}

async function loadMovie(){
  const res=await fetch(TMDB);
  const data=await res.json();
  const valid=data.results.filter(m=>m.poster_path);
  currentMovie=valid[Math.floor(Math.random()*valid.length)];
  poster.src="https://image.tmdb.org/t/p/w500"+currentMovie.poster_path;
  titulo.innerText=currentMovie.title||currentMovie.name;
}

async function handleLike(){
  if(!currentMovie) return;
  await supabase.from("matches").insert({
    user_id:currentUser.id,
    media_id:String(currentMovie.id),
    media_name:currentMovie.title||currentMovie.name,
    media_poster:"https://image.tmdb.org/t/p/w500"+currentMovie.poster_path
  });
  loadMovie();
}

function closeMatch(){
  document.getElementById("match-popup").style.display="none";
  loadMovie();
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

checkUser();
</script>

</body>
</html>
